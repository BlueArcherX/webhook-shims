# Translation Shims for Log Insight Webhooks

Translate webhooks from Log Insight 3.3+ to other services. Get alerts in your team chatroom, open an incident ticket or kick off a remediation workflow.

Log Insight sends alert notifications as HTTP POST with a JSON body. However, most third-party solutions expect incoming webhooks to be in a proprietary format. If the receiving system lacks native support for the Log Insight webhook format, a shim between them can translate the webhook format as needed. This repository provides several example shims design to work with Python 2.7+.

## Getting Started

Get the source:

1. Clone the git repository
2. Create a python virtualenv: `virtualenv venv-webhookshims`
3. Activate it: `source venv-webhookshims/bin/activate`
4. Install Flask and Requests dependencies: `pip install -r requirements.txt`

Modify and run the shim:

5. Some services require credentials or URLs. Edit individual services under `loginsightwebhookdemo/` to modify constants as needed.
6. Run `python runserver.py` - the Flask webserver starts and reports listening - default http://0.0.0.0:5001/
7. Open your browser pointed to the Flask webserver for a list of available URLs.
8. [In Log Insight, create an alert specifying the full URL](http://pubs.vmware.com/log-insight-33/topic/com.vmware.log-insight.user.doc/GUID-95177CE4-C79C-42E3-A095-450B0F93A5DA.html) for one of the shims.


## Log Insight webhook formats

The output of a LI webhook depends on the type of webhook (i.e. user or system) and type of query (user only). Letâ€™s see an example for each:

### System

```json
{
   "AlertName":" Admin Alert: Worker node has returned to service  (Host = 127.0.0.2)",
   "messages":[
      {
         "text":"This notification was generated from Log Insight node (Host = 127.0.0.2, Node Identifier = a31cad22-65c2-4131-8e6c-27790892a1f9).\n\nA worker node has returned to service after having been in maintenance mode.\n\nThe Log Insight master node (Host: <a href='https://10.113.236.182:9443/'>https://10.113.236.182:9443/</a>, Node Identifier: 88fc9956-bf9a-428b-806a-22ff07636273) reports that worker node has finished maintenance and exited maintenance mode. The node will resume receiving configuration changes and serving queries. The node is also now ready to start receiving incoming log messages. If an external load balancer is configured to distribute messages among workers, the administrator should add this node back to the pool of nodes receiving incoming messages.\n\nThis message was generated by your Log Insight installation, visit the <a href='https://www.vmware.com/support/pubs/log-insight-pubs.html'>Documentation Center</a> for more information.",
         "timestamp":1458665320514,"fields":[]
      }
   ]
}
```

### User Message Query

```json
{  
   "AlertType":1,
   "AlertName":"Hello World Alert",
   "SearchPeriod":300000,
   "HitCount":0.0,
   "HitOperator":2,
   "messages":[  
      {  
         "text":"hello world 1",
         "timestamp":1451940578545,
         "fields":[  
            { 
               "name":"Field_1",
               "content":"Content 1"
            },
            { 
               "name":"Field_2",
               "content":"Content 2"
            }
         ]
      },
      {  
         "text":"hello world 2",
         "timestamp":1451940561008,
         "fields":[  
            { 
               "name":"Field_1",
               "content":"Content 1_2"
            },
            { 
               "name":"Field_2",
               "content":"Content 2_2"
            }
         ]
      }
   ],
   "HasMoreResults":false,
   "Url":"https://10.11.12.13/s/8pgzq6",
   "EditUrl":"https://10.11.12.13/s/56monr",
   "Info":"This is an alert for all the 'Hello World' messages",
   "NumHits":2
}
```

### User Aggregation Query

```json
{ 
   "AlertType":2,
   "AlertName":"field_1 aggregated alert",
   "SearchPeriod":300000,
   "HitCount":2.0,
   "HitOperator":2,
   "messages":[ 
      { 
         "fields":[ 
            { 
               "name":"Field_1",
               "content":"Content 1"
            }
         ]
      }
   ],
   "HasMoreResults":false,
   "Url":"https://10.11.12.13/s/r25g3s",
   "EditUrl":"https://10.11.12.13/s/n3gsed",
   "Info":null,
   "NumHits":1
}
```

## Log Insight webhook configuration

There are two places in LI where webhooks can be configured:

1. [System notification: under the General page in the Administration section](http://pubs.vmware.com/log-insight-33/topic/com.vmware.log-insight.administration.doc/GUID-506AE354-3F68-43A6-8C28-70F6FA1D3D9F.html)
2. [User alerts: while creating a new user alert or by editing an existing user alert](http://pubs.vmware.com/log-insight-33/topic/com.vmware.log-insight.user.doc/GUID-95177CE4-C79C-42E3-A095-450B0F93A5DA.html)

## Creating a shim

A webhook payload translation shim should provide format conversation, logging and error handling. If the destination system expects one POST per log event, the shim should iterate over the alert's `messages` key. If posting to the destination fails, the shim should return a non-200 HTTP status back to Log Insight.

If you do add additional translation shims, please send a pull request.
