# loginsightwebhooks
Shim information for Log Insight 3.3 and newer

## Getting Started

1. Download the shim
2. Edit the shim and specify the variables desired
3. Run the shim
4. Connect to http://IP:PORT/ and read the information
5. Configure Log Insight to send a webhook to one of the supported destinations

### Log Insight webhook to 3rd party

Log Insight sends a webhook in its own proprietary format and third-party solutions expect incoming webhooks to be in their proprietary format. This means either the third-party solution needs to have native support for the Log Insight format or a shim between Log Insight and the third-party solution is needed which translates Log Insight format to third-party format.

### Log Insight webhook formats

The output of a LI webhook depends on the type of webhook (i.e. user or system) and type of query (user only). Letâ€™s see an example for each:

**System**

```json
{
   "AlertName":" Admin Alert: Worker node has returned to service  (Host = 127.0.0.2)",
   "messages":[
      {
         "text":"This notification was generated from Log Insight node (Host = 127.0.0.2, Node Identifier = a31cad22-65c2-4131-8e6c-27790892a1f9).\n\nA worker node has returned to service after having been in maintenance mode.\n\nThe Log Insight master node (Host: <a href='https://10.113.236.182:9443/'>https://10.113.236.182:9443/</a>, Node Identifier: 88fc9956-bf9a-428b-806a-22ff07636273) reports that worker node has finished maintenance and exited maintenance mode. The node will resume receiving configuration changes and serving queries. The node is also now ready to start receiving incoming log messages. If an external load balancer is configured to distribute messages among workers, the administrator should add this node back to the pool of nodes receiving incoming messages.\n\nThis message was generated by your Log Insight installation, visit the <a href='https://www.vmware.com/support/pubs/log-insight-pubs.html'>Documentation Center</a> for more information.",
         "timestamp":1458665320514,"fields":[]
      }
   ]
}
```

**User: Message Query**

```json
{  
   "AlertType":1,
   "AlertName":"Hello World Alert",
   "SearchPeriod":300000,
   "HitCount":0.0,
   "HitOperator":2,
   "messages":[  
      {  
         "text":"hello world 1",
         "timestamp":1451940578545,
         "fields":[  
            { 
               "name":"Field_1",
               "content":"Content 1"
            },
            { 
               "name":"Field_2",
               "content":"Content 2"
            }
         ]
      },
      {  
         "text":"hello world 2",
         "timestamp":1451940561008,
         "fields":[  
            { 
               "name":"Field_1",
               "content":"Content 1_2"
            },
            { 
               "name":"Field_2",
               "content":"Content 2_2"
            }
         ]
      }
   ],
   "HasMoreResults":false,
   "Url":"https://10.11.12.13/s/8pgzq6",
   "EditUrl":"https://10.11.12.13/s/56monr",
   "Info":"This is an alert for all the 'Hello World' messages",
   "NumHits":2
}
```

**User: Aggregation Query**

```json
{ 
   "AlertType":2,
   "AlertName":"field_1 aggregated alert",
   "SearchPeriod":300000,
   "HitCount":2.0,
   "HitOperator":2,
   "messages":[ 
      { 
         "fields":[ 
            { 
               "name":"Field_1",
               "content":"Content 1"
            }
         ]
      }
   ],
   "HasMoreResults":false,
   "Url":"https://10.11.12.13/s/r25g3s",
   "EditUrl":"https://10.11.12.13/s/n3gsed",
   "Info":null,
   "NumHits":1
}
```

### Log Insight webhook configuration

There are two places in LI where webhooks can be configured:

1. For system notification: under the General page in the Administration section
2. For user alerts: while creating a new user alert or by editing an existing user alert

### Creating a shim

To start, you will need a webserver that you can configure Log Insight to point to. You can either leverage an existing one, stand a new one up and write some glue to point to your shim or you can just build it into your shim. The example shim includes a webserver to make it really easy to deploy and configure.

In order to understand the Log Insight format and perform ingestion testing with your shim, it is helpful to have a test URL that will just dump the payload it receives. In the case of Log Insight webhooks, the body is the only part of the payload we really care about. In addition to handling the incoming payload from Log Insight, you will also need to see the transformation of the data as it works its way through the shim and of course the output of the translation which represents the payload that will be sent to the destination. All this means is that proper logging should be added to the shim.

Finally, you need to decide which destinations you wish to support. For this example shim, the following destinations are supported:

- Socialcast
- Slack
- PagerDuty

Of course you are welcome to add shims in different languages and/or more destinations, both of which should be easy given the test URL, existing logging, and example destinations above. If you do add destinations, please be sure to share!
